<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Tracker</title>
    <link rel="stylesheet" href="public/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>
<body >
    <!-- header -->
    <h1 class="m-5">Table Football Score Tracker</h1>

    <!-- Game Mode Toggle -->
    <div class="toggle-container">
        <button class="toggle-btn active" onclick="showSingleGame()">Single Game</button>
        <button class="toggle-btn" onclick="showTeamGame()">Team Game</button>
        <button class="toggle-btn" onclick="showStats()">Statistics</button>
    </div>

    <!-- Single Game -->
    <section class="game-section" id="singleGameSection">
        <h2>Single Game</h2>
        <h3>Winner vs Loser</h3>
        <div class="input-container">
            <div class="player-input-wrapper">
                <input type="text" id="inputBoxWinner" class="win player-input" placeholder="Winner" autocomplete="off">
                <div class="player-dropdown" id="dropdown-inputBoxWinner"></div>
            </div>
            <span class="vs">vs</span>
            <div class="player-input-wrapper">
                <input type="text" id="inputBoxLoser" class="lose player-input" placeholder="Loser" autocomplete="off">
                <div class="player-dropdown" id="dropdown-inputBoxLoser"></div>
            </div>
        </div>
        <button onclick="saveInputSingle()">Save Game</button>
        <p id="statusSingleGame"></p>
    </section>

    <!-- Team Game -->
    <section class="game-section" id="teamGameSection" style="display: none;">
        <h2>Team Game</h2>
        <h3>Winning Team vs Losing Team</h3>
        <div class="input-container">
            <div class="team-group winning-team">
                <div class="player-input-wrapper">
                    <input type="text" id="inputBoxWinnerAttack" class="win player-input" placeholder="Attacker" autocomplete="off">
                    <div class="player-dropdown" id="dropdown-inputBoxWinnerAttack"></div>
                </div>
                <div class="player-input-wrapper">
                    <input type="text" id="inputBoxWinnerDefense" class="win player-input" placeholder="Defender" autocomplete="off">
                    <div class="player-dropdown" id="dropdown-inputBoxWinnerDefense"></div>
                </div>
            </div>
            <span class="vs">vs</span>
            <div class="team-group losing-team">
                <div class="player-input-wrapper">
                    <input type="text" id="inputBoxLoserAttack" class="lose player-input" placeholder="Attacker" autocomplete="off">
                    <div class="player-dropdown" id="dropdown-inputBoxLoserAttack"></div>
                </div>
                <div class="player-input-wrapper">
                    <input type="text" id="inputBoxLoserDefense" class="lose player-input" placeholder="Defender" autocomplete="off">
                    <div class="player-dropdown" id="dropdown-inputBoxLoserDefense"></div>
                </div>
            </div>
        </div>
        <button onclick="saveInputTeam()">Save Game</button>
        <p id="statusTeamGame"></p>
    </section>

    <!-- Statistics -->
    <section class="game-section" id="statsSection" style="display: none;">
        <h2>Player Rankings</h2>
        <p class="stats-subtitle">Ranked by points</p>
        <p class="stats-subtitle">See more details on desktop, all data has been reset for new points system.</p>
        <div id="statsLoading" class="stats-loading">Loading statistics...</div>
        <div id="statsError" class="stats-error" style="display: none;"></div>

        <!-- Chart (desktop only) -->
        <div class="stats-chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <!-- Rankings list -->
        <div id="statsContainer" class="stats-container"></div>

        <!-- Recent Games -->
        <h2 style="margin-top: 3rem;">Recent Games</h2>
        <div id="recentGamesLoading" class="stats-loading">Loading recent games...</div>
        <div id="recentGamesError" class="stats-error" style="display: none;"></div>
        <div id="recentGamesContainer" class="recent-games-container"></div>
    </section>


<!-- front end JS -->
    <script>
    // Define API_BASE once, depending on hostname
    const API_BASE = window.location.hostname === 'localhost'
        ? 'http://localhost:3000'   //for local testing
        : 'https://tablefootballscoretracker.onrender.com';  // for prod

        // Global player list
        let allPlayers = [];

        // Load players on page load
        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/players`);
                if (!response.ok) throw new Error('Failed to fetch players');

                allPlayers = await response.json();
            } catch (error) {
                console.error('Error loading players:', error);
                allPlayers = [];
            }
        }

        // Initialize player dropdown for an input
        function initPlayerDropdown(inputId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(`dropdown-${inputId}`);

            if (!input || !dropdown) return;

            // Show dropdown on focus
            input.addEventListener('focus', () => {
                updateDropdown(input, dropdown);
                dropdown.style.display = 'block';
            });

            // Update dropdown as user types
            input.addEventListener('input', () => {
                updateDropdown(input, dropdown);
            });

            // Hide dropdown on blur (with delay to allow clicking)
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        // Update dropdown with filtered players
        function updateDropdown(input, dropdown) {
            const searchTerm = input.value.toLowerCase().trim();
            dropdown.innerHTML = '';

            if (searchTerm === '') {
                // Show all players when input is empty
                allPlayers.forEach(player => {
                    const item = createDropdownItem(player, input, dropdown, false);
                    dropdown.appendChild(item);
                });
            } else {
                // Filter players by search term
                const filtered = allPlayers.filter(player =>
                    player.toLowerCase().includes(searchTerm)
                );

                filtered.forEach(player => {
                    const item = createDropdownItem(player, input, dropdown, false);
                    dropdown.appendChild(item);
                });

                // Add "Add new player" option if no exact match
                const exactMatch = allPlayers.some(player =>
                    player.toLowerCase() === searchTerm
                );

                if (!exactMatch && searchTerm.length > 0) {
                    const capitalizedName = searchTerm.charAt(0).toUpperCase() + searchTerm.slice(1);
                    const addNewItem = createDropdownItem(capitalizedName, input, dropdown, true);
                    dropdown.appendChild(addNewItem);
                }
            }
        }

        // Create dropdown item
        function createDropdownItem(playerName, input, dropdown, isNewPlayer) {
            const item = document.createElement('div');
            item.className = isNewPlayer ? 'dropdown-item add-new' : 'dropdown-item';

            if (isNewPlayer) {
                item.innerHTML = `<span class="add-new-icon">+</span> Add new player: <strong>${playerName}</strong>`;
            } else {
                item.textContent = playerName;
            }

            item.addEventListener('click', () => {
                input.value = playerName;
                dropdown.style.display = 'none';

                // Add to allPlayers if new
                if (isNewPlayer && !allPlayers.includes(playerName)) {
                    allPlayers.push(playerName);
                }
            });

            return item;
        }

        // Load players and initialize dropdowns when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            await loadPlayers();

            // Initialize all player input dropdowns
            initPlayerDropdown('inputBoxWinner');
            initPlayerDropdown('inputBoxLoser');
            initPlayerDropdown('inputBoxWinnerAttack');
            initPlayerDropdown('inputBoxWinnerDefense');
            initPlayerDropdown('inputBoxLoserAttack');
            initPlayerDropdown('inputBoxLoserDefense');
        });

        // Toggle between game modes
        function showSingleGame() {
            document.getElementById('singleGameSection').style.display = 'flex';
            document.getElementById('teamGameSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.add('active');
            toggleBtns[1].classList.remove('active');
            toggleBtns[2].classList.remove('active');
        }

        function showTeamGame() {
            document.getElementById('singleGameSection').style.display = 'none';
            document.getElementById('teamGameSection').style.display = 'flex';
            document.getElementById('statsSection').style.display = 'none';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.remove('active');
            toggleBtns[1].classList.add('active');
            toggleBtns[2].classList.remove('active');
        }

        function showStats() {
            document.getElementById('singleGameSection').style.display = 'none';
            document.getElementById('teamGameSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'flex';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.remove('active');
            toggleBtns[1].classList.remove('active');
            toggleBtns[2].classList.add('active');
            loadStatistics();
            loadRecentGames();
        }

        let statsChart = null; // Keep reference to chart

        async function loadStatistics() {
            const container = document.getElementById('statsContainer');
            const loading = document.getElementById('statsLoading');
            const errorDiv = document.getElementById('statsError');

            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            container.innerHTML = '';

            // Destroy existing chart if it exists
            if (statsChart) {
                statsChart.destroy();
                statsChart = null;
            }

            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error('Failed to fetch statistics');

                const stats = await response.json();
                loading.style.display = 'none';

                if (stats.length === 0) {
                    container.innerHTML = '<div class="no-stats"><p>No games recorded yet!</p><p>Play some games to see statistics here.</p></div>';
                    return;
                }

                // Create stacked bar chart
                const ctx = document.getElementById('statsChart').getContext('2d');
                statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: stats.map(p => p.name),
                        datasets: [
                            {
                                label: 'Wins',
                                data: stats.map(p => p.totalWins),
                                backgroundColor: '#4CAF50',
                                borderColor: '#2e7832',
                                borderWidth: 1
                            },
                            {
                                label: 'Losses',
                                data: stats.map(p => p.totalLosses),
                                backgroundColor: '#f44336',
                                borderColor: '#971717',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Games'
                                }
                            },
                            y: {
                                stacked: true,
                                ticks: {
                                    autoSkip: false,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Wins vs Losses by Player',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });

                // Populate rankings list
                stats.forEach((player, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const hiddenClass = rank > 3 ? 'hidden-rank' : '';
                    const statItem = document.createElement('div');
                    statItem.className = `stat-item ${rankClass} ${hiddenClass}`;

                    statItem.innerHTML = `
                        <div class="stat-rank">#${rank}</div>
                        <div class="stat-name">${player.name}</div>
                        <div class="stat-wins">
                            <div class="stat-total">${player.rating} Points</div>
                        </div>
                    `;
                    container.appendChild(statItem);
                });

                // Add expand/collapse button if there are more than 3 players
                if (stats.length > 3) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-rankings-btn';
                    toggleBtn.textContent = `Show ${stats.length - 3} More Players`;
                    toggleBtn.onclick = () => {
                        const hiddenRanks = document.querySelectorAll('.stat-item.hidden-rank');
                        const isExpanded = toggleBtn.classList.contains('expanded');

                        if (isExpanded) {
                            hiddenRanks.forEach(item => item.classList.remove('visible'));
                            toggleBtn.textContent = `Show ${stats.length - 3} More Players`;
                            toggleBtn.classList.remove('expanded');
                        } else {
                            hiddenRanks.forEach(item => item.classList.add('visible'));
                            toggleBtn.textContent = 'Show Less';
                            toggleBtn.classList.add('expanded');
                        }
                    };
                    container.appendChild(toggleBtn);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                loading.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Failed to load statistics. Please try again.';
            }
        }

        async function loadRecentGames() {
            const container = document.getElementById('recentGamesContainer');
            const loading = document.getElementById('recentGamesLoading');
            const errorDiv = document.getElementById('recentGamesError');

            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            container.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/recentGames?limit=10`);
                if (!response.ok) throw new Error('Failed to fetch recent games');

                const games = await response.json();
                loading.style.display = 'none';

                if (games.length === 0) {
                    container.innerHTML = '<div class="no-stats"><p>No games with ratings recorded yet!</p></div>';
                    return;
                }

                games.forEach(game => {
                    const gameItem = document.createElement('div');
                    gameItem.className = 'game-item';

                    const date = new Date(game.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    if (game.type === 'single') {
                        const winner = game.players[0];
                        const loser = game.players[1];
                        const winnerSign = winner.change >= 0 ? '+' : '';
                        const loserSign = loser.change >= 0 ? '+' : '';

                        gameItem.innerHTML = `
                            <div class="game-header">
                                <div>
                                    <span class="game-type">Single Game</span>
                                    <span class="game-date">${dateStr}</span>
                                </div>
                                <button class="delete-game-btn" data-game-id="${game.id}" data-game-type="${game.type}">Delete</button>
                            </div>
                            <div class="game-players">
                                <div class="game-player winner">
                                    <span class="player-name">${winner.name}</span>
                                    <span class="player-change">${winnerSign}${winner.change}</span>
                                </div>
                                <span class="vs-small">vs</span>
                                <div class="game-player loser">
                                    <span class="player-name">${loser.name}</span>
                                    <span class="player-change">${loserSign}${loser.change}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        const winners = game.players.filter(p => p.result === 'won');
                        const losers = game.players.filter(p => p.result === 'lost');

                        const winnerAttack = winners.find(p => p.role === 'attack');
                        const winnerDefense = winners.find(p => p.role === 'defense');
                        const loserAttack = losers.find(p => p.role === 'attack');
                        const loserDefense = losers.find(p => p.role === 'defense');

                        gameItem.innerHTML = `
                            <div class="game-header">
                                <div>
                                    <span class="game-type">Team Game</span>
                                    <span class="game-date">${dateStr}</span>
                                </div>
                                <button class="delete-game-btn" data-game-id="${game.id}" data-game-type="${game.type}">Delete</button>
                            </div>
                            <div class="game-players team-game">
                                <div class="team-side winning-side">
                                    <div class="game-player winner">
                                        <span class="player-name">${winnerAttack.name} (A)</span>
                                        <span class="player-change">${winnerAttack.change >= 0 ? '+' : ''}${winnerAttack.change}</span>
                                    </div>
                                    <div class="game-player winner">
                                        <span class="player-name">${winnerDefense.name} (D)</span>
                                        <span class="player-change">${winnerDefense.change >= 0 ? '+' : ''}${winnerDefense.change}</span>
                                    </div>
                                </div>
                                <span class="vs-small">vs</span>
                                <div class="team-side losing-side">
                                    <div class="game-player loser">
                                        <span class="player-name">${loserAttack.name} (A)</span>
                                        <span class="player-change">${loserAttack.change >= 0 ? '+' : ''}${loserAttack.change}</span>
                                    </div>
                                    <div class="game-player loser">
                                        <span class="player-name">${loserDefense.name} (D)</span>
                                        <span class="player-change">${loserDefense.change >= 0 ? '+' : ''}${loserDefense.change}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    container.appendChild(gameItem);
                });

                // Add event listeners to delete buttons
                container.querySelectorAll('.delete-game-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const gameId = e.target.dataset.gameId;
                        const gameType = e.target.dataset.gameType;

                        if (!confirm('Are you sure you want to delete this game? This cannot be undone.')) {
                            return;
                        }

                        try {
                            const response = await fetch(`${API_BASE}/deleteGame/${gameType}/${gameId}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) throw new Error('Failed to delete game');

                            // Reload the games list and statistics
                            loadRecentGames();
                            loadStatistics();
                        } catch (error) {
                            console.error('Error deleting game:', error);
                            alert('Failed to delete game. Please try again.');
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading recent games:', error);
                loading.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Failed to load recent games. Please try again.';
            }
        }

        //Single game
        async function saveInputSingle() {
            const inputBoxWinner = document.getElementById("inputBoxWinner");
            const inputBoxLoser = document.getElementById("inputBoxLoser");
            //prevent spaces in input
            const winner = inputBoxWinner.value.trim();
            const loser = inputBoxLoser.value.trim();

            if (!winner || !loser) {
                return alert("Both fields are required for a single game!");
            }

            try {
                const responseSingle = await fetch(`${API_BASE}/saveSingle`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ winner, loser })
                });

                const resultSingle = await responseSingle.json();

                // Display rating changes if available
                if (resultSingle.ratings) {
                    const winnerChange = resultSingle.ratings.winner.change;
                    const loserChange = resultSingle.ratings.loser.change;
                    const winnerSign = winnerChange >= 0 ? '+' : '';
                    const loserSign = loserChange >= 0 ? '+' : '';

                    document.getElementById("statusSingleGame").innerText =
                        `${resultSingle.message} | ${resultSingle.ratings.winner.name}: ${winnerSign}${winnerChange} (${resultSingle.ratings.winner.newRating}) | ${resultSingle.ratings.loser.name}: ${loserSign}${loserChange} (${resultSingle.ratings.loser.newRating})`;
                } else {
                    document.getElementById("statusSingleGame").innerText = resultSingle.message;
                }

                // Clear fields after successful save
                inputBoxWinner.value = "";
                inputBoxLoser.value = "";

                // Reload players list to include any new players
                loadPlayers();

                // Celebrate with confetti!
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } catch (error) {
                console.error("Error saving single game:", error);
                alert("Failed to save data. Check server connection.");
            }
        }
        //team game
        async function saveInputTeam() {
            const inputBoxWinnerAttack = document.getElementById("inputBoxWinnerAttack");
            const inputBoxWinnerDefense = document.getElementById("inputBoxWinnerDefense");
            const inputBoxLoserAttack = document.getElementById("inputBoxLoserAttack");
            const inputBoxLoserDefense = document.getElementById("inputBoxLoserDefense");
            //prevent spaces in input
            const winnerAttack = inputBoxWinnerAttack.value.trim();
            const winnerDefense = inputBoxWinnerDefense.value.trim();
            const loserAttack = inputBoxLoserAttack.value.trim();
            const loserDefense = inputBoxLoserDefense.value.trim();

            if (!winnerAttack || !winnerDefense || !loserAttack || !loserDefense) {
                return alert("All fields are required for a team game!");
            }

            try {
                const responseTeam = await fetch(`${API_BASE}/saveTeam`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ winnerAttack, winnerDefense, loserAttack, loserDefense })
                });

                const resultTeam = await responseTeam.json();

                // Display rating changes if available
                if (resultTeam.ratings) {
                    const r = resultTeam.ratings;
                    const changes = [
                        `${r.winnerAttack.name}: ${r.winnerAttack.change >= 0 ? '+' : ''}${r.winnerAttack.change}`,
                        `${r.winnerDefense.name}: ${r.winnerDefense.change >= 0 ? '+' : ''}${r.winnerDefense.change}`,
                        `${r.loserAttack.name}: ${r.loserAttack.change >= 0 ? '+' : ''}${r.loserAttack.change}`,
                        `${r.loserDefense.name}: ${r.loserDefense.change >= 0 ? '+' : ''}${r.loserDefense.change}`
                    ].join(' | ');

                    document.getElementById("statusTeamGame").innerText =
                        `${resultTeam.message} | ${changes}`;
                } else {
                    document.getElementById("statusTeamGame").innerText = resultTeam.message;
                }

                // Clear fields after successful save
                inputBoxWinnerAttack.value = "";
                inputBoxWinnerDefense.value = "";
                inputBoxLoserAttack.value = "";
                inputBoxLoserDefense.value = "";

                // Reload players list to include any new players
                loadPlayers();

                // Celebrate with confetti!
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } catch (error) {
                console.error("Error saving team game:", error);
                alert("Failed to save data. Check server connection.");
            }
        }
    </script>
</body>
</html>
