<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Tracker</title>
    <link rel="stylesheet" href="public/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body >
    <!-- header -->
    <h1 class="m-5">Table Football Score Tracker</h1>

    <!-- Game Mode Toggle -->
    <div class="toggle-container">
        <button class="toggle-btn active" onclick="showSingleGame()">Single Game</button>
        <button class="toggle-btn" onclick="showTeamGame()">Team Game</button>
        <button class="toggle-btn" onclick="showStats()">Statistics</button>
    </div>

    <!-- Single Game -->
    <section class="game-section" id="singleGameSection">
        <h2>Single Game</h2>
        <h3>Winner vs Loser</h3>
        <div class="input-container">
            <input type="text" id="inputBoxWinner" class="win" placeholder="Winner" list="playersList">
            <span class="vs">vs</span>
            <input type="text" id="inputBoxLoser" class="lose" placeholder="Loser" list="playersList">
        </div>
        <button onclick="saveInputSingle()">Save Game</button>
        <p id="statusSingleGame"></p>
    </section>

    <!-- Team Game -->
    <section class="game-section" id="teamGameSection" style="display: none;">
        <h2>Team Game</h2>
        <h3>Winning Team vs Losing Team</h3>
        <div class="input-container">
            <div class="team-group winning-team">
                <input type="text" id="inputBoxWinnerAttack" class="win" placeholder="Attacker" list="playersList">
                <input type="text" id="inputBoxWinnerDefense" class="win" placeholder="Defender" list="playersList">
            </div>
            <span class="vs">vs</span>
            <div class="team-group losing-team">
                <input type="text" id="inputBoxLoserAttack" class="lose" placeholder="Attacker" list="playersList">
                <input type="text" id="inputBoxLoserDefense" class="lose" placeholder="Defender" list="playersList">
            </div>
        </div>
        <button onclick="saveInputTeam()">Save Game</button>
        <p id="statusTeamGame"></p>
    </section>

    <!-- Statistics -->
    <section class="game-section" id="statsSection" style="display: none;">
        <h2>Player Rankings</h2>
        <p class="stats-subtitle">Ranked by points</p>
        <div id="statsLoading" class="stats-loading">Loading statistics...</div>
        <div id="statsError" class="stats-error" style="display: none;"></div>

        <!-- Chart (desktop only) -->
        <div class="stats-chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <!-- Rankings list -->
        <div id="statsContainer" class="stats-container"></div>
    </section>


<!-- Player datalist for autocomplete -->
    <datalist id="playersList">
        <!-- Populated dynamically via JavaScript -->
    </datalist>

<!-- front end JS -->
    <script>
    // Define API_BASE once, depending on hostname
    const API_BASE = window.location.hostname === 'localhost'
        ? 'http://localhost:3000'   //for local testing
        : 'https://tablefootballscoretracker.onrender.com';  // for prod

        // Load players on page load
        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/players`);
                if (!response.ok) throw new Error('Failed to fetch players');

                const players = await response.json();
                const datalist = document.getElementById('playersList');
                datalist.innerHTML = ''; // Clear existing options

                // Populate datalist with player names
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading players:', error);
                // Silently fail - user can still type names manually
            }
        }

        // Load players when page loads
        window.addEventListener('DOMContentLoaded', loadPlayers);

        // Toggle between game modes
        function showSingleGame() {
            document.getElementById('singleGameSection').style.display = 'flex';
            document.getElementById('teamGameSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.add('active');
            toggleBtns[1].classList.remove('active');
            toggleBtns[2].classList.remove('active');
        }

        function showTeamGame() {
            document.getElementById('singleGameSection').style.display = 'none';
            document.getElementById('teamGameSection').style.display = 'flex';
            document.getElementById('statsSection').style.display = 'none';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.remove('active');
            toggleBtns[1].classList.add('active');
            toggleBtns[2].classList.remove('active');
        }

        function showStats() {
            document.getElementById('singleGameSection').style.display = 'none';
            document.getElementById('teamGameSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'flex';
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns[0].classList.remove('active');
            toggleBtns[1].classList.remove('active');
            toggleBtns[2].classList.add('active');
            loadStatistics();
        }

        let statsChart = null; // Keep reference to chart

        async function loadStatistics() {
            const container = document.getElementById('statsContainer');
            const loading = document.getElementById('statsLoading');
            const errorDiv = document.getElementById('statsError');

            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            container.innerHTML = '';

            // Destroy existing chart if it exists
            if (statsChart) {
                statsChart.destroy();
                statsChart = null;
            }

            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error('Failed to fetch statistics');

                const stats = await response.json();
                loading.style.display = 'none';

                if (stats.length === 0) {
                    container.innerHTML = '<div class="no-stats"><p>No games recorded yet!</p><p>Play some games to see statistics here.</p></div>';
                    return;
                }

                // Create stacked bar chart
                const ctx = document.getElementById('statsChart').getContext('2d');
                statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: stats.map(p => p.name),
                        datasets: [
                            {
                                label: 'Wins',
                                data: stats.map(p => p.totalWins),
                                backgroundColor: '#4CAF50',
                                borderColor: '#2e7832',
                                borderWidth: 1
                            },
                            {
                                label: 'Losses',
                                data: stats.map(p => p.totalLosses),
                                backgroundColor: '#f44336',
                                borderColor: '#971717',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Games'
                                }
                            },
                            y: {
                                stacked: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Wins vs Losses by Player',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });

                // Populate rankings list
                stats.forEach((player, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const statItem = document.createElement('div');
                    statItem.className = `stat-item ${rankClass}`;
                    statItem.innerHTML = `
                        <div class="stat-rank">#${rank}</div>
                        <div class="stat-name">${player.name}</div>
                        <div class="stat-wins">
                            <div class="stat-total">${player.rating} Points</div>
                        </div>
                    `;
                    container.appendChild(statItem);
                });
            } catch (error) {
                console.error('Error loading statistics:', error);
                loading.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Failed to load statistics. Please try again.';
            }
        }

        //Single game
        async function saveInputSingle() {
            const inputBoxWinner = document.getElementById("inputBoxWinner");
            const inputBoxLoser = document.getElementById("inputBoxLoser");
            //prevent spaces in input
            const winner = inputBoxWinner.value.trim();
            const loser = inputBoxLoser.value.trim();

            if (!winner || !loser) {
                return alert("Both fields are required for a single game!");
            }

            try {
                const responseSingle = await fetch(`${API_BASE}/saveSingle`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ winner, loser })
                });

                const resultSingle = await responseSingle.json();

                // Display rating changes if available
                if (resultSingle.ratings) {
                    const winnerChange = resultSingle.ratings.winner.change;
                    const loserChange = resultSingle.ratings.loser.change;
                    const winnerSign = winnerChange >= 0 ? '+' : '';
                    const loserSign = loserChange >= 0 ? '+' : '';

                    document.getElementById("statusSingleGame").innerText =
                        `${resultSingle.message} | ${resultSingle.ratings.winner.name}: ${winnerSign}${winnerChange} (${resultSingle.ratings.winner.newRating}) | ${resultSingle.ratings.loser.name}: ${loserSign}${loserChange} (${resultSingle.ratings.loser.newRating})`;
                } else {
                    document.getElementById("statusSingleGame").innerText = resultSingle.message;
                }

                // Clear fields after successful save
                inputBoxWinner.value = "";
                inputBoxLoser.value = "";

                // Reload players list to include any new players
                loadPlayers();
            } catch (error) {
                console.error("Error saving single game:", error);
                alert("Failed to save data. Check server connection.");
            }
        }
        //team game
        async function saveInputTeam() {
            const inputBoxWinnerAttack = document.getElementById("inputBoxWinnerAttack");
            const inputBoxWinnerDefense = document.getElementById("inputBoxWinnerDefense");
            const inputBoxLoserAttack = document.getElementById("inputBoxLoserAttack");
            const inputBoxLoserDefense = document.getElementById("inputBoxLoserDefense");
            //prevent spaces in input
            const winnerAttack = inputBoxWinnerAttack.value.trim();
            const winnerDefense = inputBoxWinnerDefense.value.trim();
            const loserAttack = inputBoxLoserAttack.value.trim();
            const loserDefense = inputBoxLoserDefense.value.trim();

            if (!winnerAttack || !winnerDefense || !loserAttack || !loserDefense) {
                return alert("All fields are required for a team game!");
            }

            try {
                const responseTeam = await fetch(`${API_BASE}/saveTeam`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ winnerAttack, winnerDefense, loserAttack, loserDefense })
                });

                const resultTeam = await responseTeam.json();

                // Display rating changes if available
                if (resultTeam.ratings) {
                    const r = resultTeam.ratings;
                    const changes = [
                        `${r.winnerAttack.name}: ${r.winnerAttack.change >= 0 ? '+' : ''}${r.winnerAttack.change}`,
                        `${r.winnerDefense.name}: ${r.winnerDefense.change >= 0 ? '+' : ''}${r.winnerDefense.change}`,
                        `${r.loserAttack.name}: ${r.loserAttack.change >= 0 ? '+' : ''}${r.loserAttack.change}`,
                        `${r.loserDefense.name}: ${r.loserDefense.change >= 0 ? '+' : ''}${r.loserDefense.change}`
                    ].join(' | ');

                    document.getElementById("statusTeamGame").innerText =
                        `${resultTeam.message} | ${changes}`;
                } else {
                    document.getElementById("statusTeamGame").innerText = resultTeam.message;
                }

                // Clear fields after successful save
                inputBoxWinnerAttack.value = "";
                inputBoxWinnerDefense.value = "";
                inputBoxLoserAttack.value = "";
                inputBoxLoserDefense.value = "";

                // Reload players list to include any new players
                loadPlayers();
            } catch (error) {
                console.error("Error saving team game:", error);
                alert("Failed to save data. Check server connection.");
            }
        }
    </script>
</body>
</html>
